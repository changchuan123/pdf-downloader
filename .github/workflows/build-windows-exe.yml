name: Build Windows EXE

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Build Windows executable
      run: pyinstaller pdf_downloader_win.spec --clean
        
    - name: Test executable
      run: |
        if (Test-Path "dist/PDFä¸‹è½½å™¨.exe") {
          Write-Host "âœ… exeæ–‡ä»¶ç”ŸæˆæˆåŠŸ"
          Get-ItemProperty "dist/PDFä¸‹è½½å™¨.exe" | Select-Object Name, Length
        } else {
          Write-Host "âŒ exeæ–‡ä»¶æœªæ‰¾åˆ°"
          exit 1
        }
      shell: pwsh
      
    - name: Create release package
      run: |
        New-Item -ItemType Directory -Path "release" -Force
        Copy-Item "dist/PDFä¸‹è½½å™¨.exe" "release/" -Force
        Copy-Item "test_urls.xlsx" "release/" -Force -ErrorAction SilentlyContinue
        Copy-Item "urls.xlsx" "release/" -Force -ErrorAction SilentlyContinue
        
        $readmeContent = "PDFä¸‹è½½å™¨ Windowsç‰ˆä½¿ç”¨è¯´æ˜`n============================`n`nä½¿ç”¨æ–¹æ³•ï¼š`n1. å°† PDFä¸‹è½½å™¨.exe å’Œ Excelæ–‡ä»¶æ”¾åœ¨åŒä¸€æ–‡ä»¶å¤¹`n2. åŒå‡»è¿è¡Œ PDFä¸‹è½½å™¨.exe`n3. ä¸‹è½½çš„æ–‡ä»¶ä¼šä¿å­˜åœ¨ pdf_dl æ–‡ä»¶å¤¹ä¸­`n`nExcelæ–‡ä»¶è¦æ±‚ï¼š`n- æ–‡ä»¶åï¼šurls.xlsx æˆ– test_urls.xlsx`n- ç¬¬ä¸€åˆ—ï¼šPDFä¸‹è½½é“¾æ¥`n- ç¬¬äºŒåˆ—ï¼šæ–‡ä»¶åï¼ˆå¯é€‰ï¼‰`n`næ³¨æ„äº‹é¡¹ï¼š`n- å¦‚æœæ€æ¯’è½¯ä»¶è¯¯æŠ¥ï¼Œè¯·æ·»åŠ åˆ°ç™½åå•`n- ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸`n- ç¨‹åºæ”¯æŒå¹¶å‘ä¸‹è½½ï¼Œè¯·è€å¿ƒç­‰å¾…`n`nç”Ÿæˆæ—¶é—´ï¼š$(Get-Date)"
        
        $readmeContent | Out-File -FilePath "release/README.txt" -Encoding UTF8
        
        Write-Host "å‘å¸ƒåŒ…å†…å®¹ï¼š"
        Get-ChildItem "release"
      shell: pwsh
      
    - name: Create ZIP package
      run: |
        Compress-Archive -Path "release/*" -DestinationPath "PDFä¸‹è½½å™¨-Windows-v$(Get-Date -Format 'yyyyMMdd-HHmm').zip"
        Write-Host "ZIPåŒ…å·²åˆ›å»ºï¼š"
        Get-ChildItem "*.zip"
      shell: pwsh
      
    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: PDFä¸‹è½½å™¨-Windows-exe
        path: release/
        retention-days: 30
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: github.ref == 'refs/heads/main'
      with:
        tag_name: v${{ github.run_number }}
        name: PDFä¸‹è½½å™¨ Windowsç‰ˆ v${{ github.run_number }}
        body: |
          ## PDFæ‰¹é‡ä¸‹è½½å™¨ Windowsç‰ˆ
          
          ### ğŸ‰ æ–°åŠŸèƒ½
          - ç‹¬ç«‹çš„Windowså¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ— éœ€Pythonç¯å¢ƒ
          - æ”¯æŒExcelå’ŒTXTæ ¼å¼çš„URLåˆ—è¡¨
          - å¹¶å‘ä¸‹è½½ï¼Œæé«˜æ•ˆç‡
          - è‡ªåŠ¨å¤„ç†æ–‡ä»¶åå†²çª
          
          ### ğŸ“ åŒ…å«æ–‡ä»¶
          - PDFä¸‹è½½å™¨.exe - ä¸»ç¨‹åº
          - test_urls.xlsx - æµ‹è¯•URLæ–‡ä»¶
          - urls.xlsx - URLæ¨¡æ¿æ–‡ä»¶
          - README.txt - ä½¿ç”¨è¯´æ˜
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¹¶è§£å‹ZIPæ–‡ä»¶
          2. å°†Excelæ–‡ä»¶å’Œexeæ”¾åœ¨åŒä¸€æ–‡ä»¶å¤¹
          3. åŒå‡»è¿è¡ŒPDFä¸‹è½½å™¨.exe
          
          æ„å»ºæ—¶é—´ï¼š${{ github.run_id }}
        files: |
          PDFä¸‹è½½å™¨-Windows-v*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload build logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-logs
        path: |
          build/
          *.log
        retention-days: 7 